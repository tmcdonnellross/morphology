<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Morphology Practice — Expanded</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; }
    .card { transition: transform .2s, box-shadow .2s; }
    .card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / .1), 0 4px 6px -4px rgb(0 0 0 / .1); }
    .drop-zone { border: 2px dashed #cbd5e1; background:#f1f5f9; transition: background .2s; }
    .drop-zone.drag-over { background:#e0e7ff; border-color:#818cf8; }
    .draggable { cursor: grab; user-select:none; }
    .draggable:active { cursor: grabbing; }
    .hunt-word.selected { background-color:#c7d2fe; border-color:#818cf8; color:#4338ca; }
    .bg-activity-sums        { background-color:#ecfdf5; }
    .bg-activity-cloze       { background-color:#eff6ff; }
    .bg-activity-matrix      { background-color:#f5f3ff; }
    .bg-activity-hunt        { background-color:#fdf2f8; }
    .bg-activity-chaining    { background-color:#fefce8; }
    .bg-activity-default     { background-color:#f8fafc; }
  </style>
</head>
<body class="bg-activity-default text-slate-800">
<div class="min-h-screen p-4 sm:p-6 lg:p-8" id="app">
  <main id="page-main-menu" class="max-w-4xl mx-auto">
    <header class="text-center mb-10">
      <h1 class="text-4xl sm:text-5xl font-bold text-slate-900">Morphology Practice</h1>
      <p class="mt-2 text-lg text-slate-600">Select a category to start learning.</p>
    </header>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div onclick="showMorphemeList('prefixes')" class="card cursor-pointer bg-white p-6 rounded-2xl shadow-md border flex flex-col items-center text-center">
        <div class="bg-violet-100 text-violet-600 p-4 rounded-xl mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"/></svg>
        </div>
        <h2 class="text-2xl font-semibold text-slate-900">Prefixes</h2>
      </div>
      <div onclick="showMorphemeList('suffixes')" class="card cursor-pointer bg-white p-6 rounded-2xl shadow-md border flex flex-col items-center text-center">
        <div class="bg-sky-100 text-sky-600 p-4 rounded-xl mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 3 7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/><path d="m13 13 6 6"/></svg>
        </div>
        <h2 class="text-2xl font-semibold text-slate-900">Suffixes</h2>
      </div>
      <div onclick="showMorphemeList('bases')" class="card cursor-pointer bg-white p-6 rounded-2xl shadow-md border flex flex-col items-center text-center">
        <div class="bg-emerald-100 text-emerald-600 p-4 rounded-xl mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
        </div>
        <h2 class="text-2xl font-semibold text-slate-900">Base Words</h2>
      </div>
    </div>
  </main>

  <div id="page-morpheme-list" class="hidden max-w-5xl mx-auto">
    <header class="mb-8">
      <button onclick="showPage('page-main-menu')" class="flex items-center text-slate-600 hover:text-slate-900 font-medium">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>Back to categories
      </button>
      <h1 id="morpheme-list-title" class="text-3xl font-bold text-slate-900 mt-2"></h1>
    </header>
    <div id="morpheme-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
  </div>

  <div id="page-activity-menu" class="hidden max-w-4xl mx-auto">
    <header class="mb-10">
      <button id="back-to-morpheme-list" class="flex items-center text-slate-600 hover:text-slate-900 font-medium">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>Back to list
      </button>
      <div class="text-center">
        <h1 class="text-4xl font-bold text-slate-900">Activities for <span id="selected-morpheme-title" class="text-violet-600"></span></h1>
        <p class="mt-2 text-lg text-slate-600">Choose an activity to practice this morpheme.</p>
      </div>
    </header>
    <div id="activity-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <div data-activity="page-word-sums" onclick="showActivityPage('page-word-sums')" class="card cursor-pointer bg-white p-6 rounded-2xl shadow-md border">
        <h2 class="text-xl font-semibold text-slate-900 mb-1">Word Sums</h2>
        <p class="text-slate-500 text-sm">Combine morphemes to build words.</p>
      </div>
      <div data-activity="page-fill-in-blanks" onclick="showActivityPage('page-fill-in-blanks')" class="card cursor-pointer bg-white p-6 rounded-2xl shadow-md border">
        <h2 class="text-xl font-semibold text-slate-900 mb-1">Fill-in-the-Blanks</h2>
        <p class="text-slate-500 text-sm">Drag words into the correct sentences.</p>
      </div>
      <div data-activity="page-word-matrix" onclick="showActivityPage('page-word-matrix')" class="card cursor-pointer bg-white p-6 rounded-2xl shadow-md border">
        <h2 class="text-xl font-semibold text-slate-900 mb-1">Word Matrix</h2>
        <p class="text-slate-500 text-sm">Combine morphemes from the grid.</p>
      </div>
      <div data-activity="page-morpheme-hunt" onclick="showActivityPage('page-morpheme-hunt')" class="card cursor-pointer bg-white p-6 rounded-2xl shadow-md border">
        <h2 class="text-xl font-semibold text-slate-900 mb-1">Morpheme Hunt</h2>
        <p class="text-slate-500 text-sm">Find words with the target morpheme.</p>
      </div>
      <div data-activity="page-spelling-chaining" onclick="showActivityPage('page-spelling-chaining')" class="card cursor-pointer bg-white p-6 rounded-2xl shadow-md border">
        <h2 class="text-xl font-semibold text-slate-900 mb-1">Spelling Chaining</h2>
        <p class="text-slate-500 text-sm">Build a chain of words step-by-step.</p>
      </div>
    </div>
  </div>

  <div id="page-word-sums" class="hidden max-w-3xl mx-auto"></div>
  <div id="page-fill-in-blanks" class="hidden max-w-4xl mx-auto"></div>
  <div id="page-word-matrix" class="hidden max-w-5xl mx-auto"></div>
  <div id="page-morpheme-hunt" class="hidden max-w-4xl mx-auto"></div>
  <div id="page-spelling-chaining" class="hidden max-w-3xl mx-auto"></div>
</div>

<template id="word-sums-template">
  <header class="flex items-center justify-between mb-8">
    <div>
      <button onclick="showPage('page-activity-menu')" class="flex items-center text-slate-600 hover:text-slate-900 font-medium">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>Back
      </button>
      <h1 class="text-3xl font-bold text-slate-900 mt-2">Word Sums</h1>
    </div>
    <button onclick="generateWordSums()" class="bg-violet-500 hover:bg-violet-600 text-white font-bold py-2 px-4 rounded-lg">New Set</button>
  </header>
  <div id="word-sums-container" class="space-y-4"></div>
  <div class="mt-8 text-center">
    <button onclick="checkWordSums()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-lg text-lg">Check</button>
    <p id="word-sums-score" class="mt-4 text-lg font-medium"></p>
  </div>
</template>

<template id="fill-in-blanks-template">
  <header class="flex items-center justify-between mb-8">
    <div>
      <button onclick="showPage('page-activity-menu')" class="flex items-center text-slate-600 hover:text-slate-900 font-medium">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>Back
      </button>
      <h1 class="text-3xl font-bold text-slate-900 mt-2">Fill-in-the-Blanks</h1>
    </div>
    <button onclick="generateClozeActivity()" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg">New Set</button>
  </header>
  <p class="text-center text-slate-600 mb-8 bg-slate-100 p-4 rounded-lg">Drag the words from the word bank to complete the sentences.</p>
  <div id="cloze-activity-container">
    <div class="mb-8 p-4 bg-white rounded-lg shadow-sm border">
      <h3 class="font-semibold mb-3 text-center">Word Bank</h3>
      <div id="cloze-word-bank" class="flex flex-wrap justify-center gap-3"></div>
    </div>
    <div id="cloze-sentences" class="space-y-4 text-lg"></div>
  </div>
  <div class="mt-8 text-center">
    <button onclick="checkClozeAnswers()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-lg text-lg">Check</button>
    <p id="cloze-score" class="mt-4 text-lg font-medium"></p>
  </div>
</template>

<template id="word-matrix-template">
  <header class="flex items-center justify-between mb-8">
    <div>
      <button onclick="showPage('page-activity-menu')" class="flex items-center text-slate-600 hover:text-slate-900 font-medium">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>Back
      </button>
      <h1 class="text-3xl font-bold text-slate-900 mt-2">Word Matrix</h1>
    </div>
    <button onclick="generateWordMatrix()" class="bg-rose-500 hover:bg-rose-600 text-white font-bold py-2 px-4 rounded-lg">Reset</button>
  </header>
  <p class="text-center text-slate-600 mb-8 bg-slate-100 p-4 rounded-lg">Click the morphemes from the lists to build valid words. Find as many as you can!</p>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <div class="md:col-span-2 bg-white p-6 rounded-2xl shadow-md border">
      <div id="matrix-builder-area" class="mb-4">
        <div id="matrix-current-word" class="flex items-center justify-center p-4 bg-slate-100 rounded-lg mb-4 h-16 text-2xl font-mono text-center"></div>
        <div class="flex justify-center gap-4">
          <button onclick="submitMatrixWord()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg">Submit</button>
          <button onclick="clearMatrixWord()" class="bg-slate-400 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded-lg">Clear</button>
        </div>
        <p id="matrix-feedback" class="text-center mt-3 h-6 font-medium"></p>
      </div>
      <div id="matrix-grid" class="grid grid-cols-3 gap-4 text-center">
        <div><h3 class="font-bold mb-2 border-b-2 pb-1">Prefixes</h3><div id="matrix-prefixes" class="space-y-2"></div></div>
        <div><h3 class="font-bold mb-2 border-b-2 pb-1">Bases</h3><div id="matrix-bases" class="space-y-2"></div></div>
        <div><h3 class="font-bold mb-2 border-b-2 pb-1">Suffixes</h3><div id="matrix-suffixes" class="space-y-2"></div></div>
      </div>
    </div>
    <div class="bg-white p-6 rounded-2xl shadow-md border">
      <h3 class="font-bold text-lg mb-3 text-center">Correct Words Found (<span id="matrix-found-count">0</span>)</h3>
      <ul id="matrix-found-list" class="space-y-2 h-80 overflow-y-auto bg-slate-50 p-3 rounded-lg"></ul>
    </div>
  </div>
</template>

<template id="morpheme-hunt-template">
  <header class="flex items-center justify-between mb-8">
    <div>
      <button onclick="showPage('page-activity-menu')" class="flex items-center text-slate-600 hover:text-slate-900 font-medium">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>Back
      </button>
      <h1 class="text-3xl font-bold text-slate-900 mt-2">Morpheme Hunt</h1>
    </div>
    <button onclick="generateMorphemeHunt()" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded-lg">New Set</button>
  </header>
  <p id="hunt-instructions" class="text-center text-slate-600 mb-8 bg-slate-100 p-4 rounded-lg"></p>
  <div id="hunt-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
  <div class="mt-8 text-center">
    <button onclick="checkMorphemeHunt()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-lg text-lg">Check</button>
    <p id="hunt-score" class="mt-4 text-lg font-medium"></p>
  </div>
</template>

<template id="spelling-chaining-template">
  <header class="flex items-center justify-between mb-8">
    <div>
      <button onclick="showPage('page-activity-menu')" class="flex items-center text-slate-600 hover:text-slate-900 font-medium">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>Back
      </button>
      <h1 class="text-3xl font-bold text-slate-900 mt-2">Spelling Chaining</h1>
    </div>
    <button onclick="generateSpellingChaining()" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg">New Chain</button>
  </header>
  <div id="chaining-container" class="space-y-3 bg-white p-6 rounded-2xl shadow-md border"></div>
</template>

<script>
const morphemes = {
  prefixes: ["un-","re-","dis-","semi-","sub-","mis-","multi-","pre-","trans-","non-","fore-","inter-","over-","uni-","bi-","tri-"],
  suffixes: ["-s","-ing","-ed","-ly","-er","-est","-ful","-less","-tion","-able","-ible","-ure"],
  bases:    ["aqua","aud","bio","port","rupt","scrib","spect","struct","tract","vid","ject","bene","dict","phon","photo"]
};

const DICT = {
  port: ["port","ports","porter","porters","porting","ported","portable","report","reports","reported","reporting","reporter","import","imports","imported","importer","export","exports","exported","exporter","transport","transported","transportation","support","supports","supported","supporter","airport","portfolio"],
  struct: ["struct","structure","structures","construct","constructed","constructing","construction","constructive","reconstruct","reconstruction","deconstruct","instruct","instructed","instructing","instruction","instructor","obstruct","obstructed","obstruction","destruct","destructive","destruction","infrastructure"],
  tract: ["tract","tractor","traction","attract","attraction","attractive","subtract","subtraction","retract","retraction","contract","contracts","contractor","protract","distract","distraction"],
  spect: ["spect","spectator","inspect","inspection","respect","respectful","respective","prospect","retrospect","expect","expectation","suspect","perspective","aspect"],
  rupt: ["rupt","rupture","erupt","eruption","interrupt","interruption","disrupt","disruption","corrupt","corruption","abrupt","abruptly"],
  scrib: ["scribe","scribble","describe","description","prescribe","prescription","subscribe","subscription","inscribe","inscription","transcribe","transcription","manuscript","script","scripture"],
  aud: ["audio","audible","inaudible","audience","audition","auditorium","applaud","applauded"],
  ject: ["project","projector","projectile","reject","rejection","inject","injection","eject","ejection","object","objection","subject","subjective","bisect","trisect"],
  dict: ["dictate","dictation","dictator","dictionary","predict","prediction","predictable","unpredictable","contradict","contradiction","verdict"],
  vid: ["video","provide","provided","providing","evident","evidence","evidently","vision","visible","invisible","visitor"],
  phon: ["phone","telephone","microphone","symphony","phonics","phonic","phonetic"],
  photo: ["photograph","photographer","photography","photographic","telephoto","photocopy","photosynthesis"],
  bene: ["benefit","beneficial","benefactor","benevolent","benediction"],
  bio: ["biology","biography","biographies","biological","biologist","antibiotic","autobiography","bionic"],
  aqua: ["aquatic","aquamarine","aqueduct","aquarium","aquariums","aquaplane"],
  "un-": ["unhappy","unusual","unable","unclear","unsafe","untie","unfold","unlock","unfair","unseen","undo","unpack","unplug","unzip","unfriendly","unwise"],
  "re-": ["rebuild","review","replay","return","recycle","redo","rewrite","remake","react","reheat","reopen","retake","rethink"],
  "dis-": ["disagree","dislike","disconnect","dishonest","disappear","disallow","disapprove","disobey","disorder","displease","distrust","disable"],
  "semi-": ["semicircle","semifinal","semiconscious","semiannual","semicolon","semisweet"],
  "sub-": ["subway","submarine","submerge","subtract","subzero","subgroup","subtitle","subheading","subclass","subsoil","subtropical","substandard"],
  "mis-": ["misspell","mislead","mistrust","misunderstand","misbehave","misplace","misuse","misread","misjudge"],
  "multi-": ["multitask","multicolor","multicultural","multiply","multivitamin","multiplayer","multimedia","multinational","multipurpose"],
  "pre-": ["preview","preheat","preorder","preschool","prejudge","prepare","predict","prepay","preplan","prewrite","pretest"],
  "trans-": ["transport","transplant","transform","translate","transaction","transmit","transfer","transit","transparent"],
  "non-": ["nonsense","nonstop","nonfat","nonprofit","nonfiction","nonliving","nontoxic","nonviolent"],
  "fore-": ["foresee","forehead","forecast","foreground","foretell","forewarn"],
  "inter-": ["interact","interview","international","interrupt","interstate","internet","internal","interfere"],
  "over-": ["overflow","overcook","overlook","overreact","overconfident","overheat","overwork","overuse","overestimate"],
  "uni-": ["uniform","unicycle","universe","unison","unify","unique","united","unit"],
  "bi-": ["bicycle","biweekly","biplane","bilingual","bisect","biannual","bimodal"],
  "tri-": ["triangle","tripod","tricycle","trilogy","trio","trisect"],
  "-s": ["cats","dogs","runs","books","trees","cars","houses","players","teachers","rivers","flowers","stars"],
  "-ing": ["running","jumping","reading","singing","working","playing","writing","driving","painting","swimming"],
  "-ed": ["walked","jumped","played","looked","asked","helped","called","learned","closed","opened"],
  "-ly": ["quickly","softly","loudly","bravely","calmly","happily","sadly","kindly","safely","politely","firmly"],
  "-er": ["teacher","worker","painter","stronger","faster","runner","reader","writer","player","leader"],
  "-est": ["fastest","tallest","smallest","coldest","longest","biggest","brightest","strongest","youngest"],
  "-ful": ["hopeful","careful","joyful","wonderful","painful","beautiful","colorful","grateful","playful"],
  "-less": ["fearless","hopeless","endless","careless","useless","harmless","tireless","restless"],
  "-tion": ["action","protection","education","creation","direction","vacation","nation","station","mention","question"],
  "-able": ["readable","portable","comfortable","breakable","acceptable","reliable","doable","washable"],
  "-ible": ["audible","visible","flexible","reversible","accessible","incredible","sensible"],
  "-ure": ["pressure","creature","mixture","failure","enclosure","future","treasure","measure","figure"]
};

const MATRIX_SPEC = {
  port:   {prefixes:["re-","im-","ex-","trans-","sup-","un-","de-","tele-"], bases:["port"], suffixes:["-s","-ed","-er","-ing","-able","-ation"]},
  struct: {prefixes:["con-","de-","re-","in-","ob-"], bases:["struct"], suffixes:["-s","-ed","-ing","-ion","-ive","-ure","-al","-ly"]},
  tract:  {prefixes:["re-","sub-","at-","dis-","con-","pro-"], bases:["tract"], suffixes:["-s","-ed","-ing","-ion","-or","-ive"]},
  spect:  {prefixes:["in-","re-","pro-","retro-","ex-"], bases:["spect"], suffixes:["-s","-ed","-ing","-ion","-or","-ive","-ful"]},
  rupt:   {prefixes:["dis-","inter-","e-","ab-","cor-"], bases:["rupt"], suffixes:["-s","-ed","-ing","-ion","-ive","-ly"]},
  scrib:  {prefixes:["de-","sub-","pre-","in-","trans-","mis-"], bases:["scrib","script"], suffixes:["-s","-ed","-ing","-ion","-ure","-ive"]},
  aud:    {prefixes:["in-"], bases:["aud"], suffixes:["-io","-ible","-ience","-ition","-itorium"]},
  ject:   {prefixes:["pro-","re-","in-","e-","ob-","sub-","bi-","tri-"], bases:["ject"], suffixes:["-s","-ed","-ing","-ion","-ile","-or","-ive"]},
  dict:   {prefixes:["pre-","contra-","ver-"], bases:["dict"], suffixes:["-s","-ate","-ion","-or","-ionary","-able"]},
  vid:    {prefixes:["in-","pro-","e-"], bases:["vid","vis"], suffixes:["-eo","-ent","-ion","-ible","-itor","-ion-ary"]},
  phon:   {prefixes:["tele-","micro-","sym-"], bases:["phon"], suffixes:["-e","-ic","-ics","-y","-etic"]},
  photo:  {prefixes:["tele-"], bases:["photo"], suffixes:["-graph","-graphy","-ic","-copy"]},
  bene:   {prefixes:[], bases:["bene"], suffixes:["-fit","-volent","-factor","-diction","-ficial"]},
  bio:    {prefixes:["anti-","auto-"], bases:["bio"], suffixes:["-logy","-graphy","-tic","-logical","-logist"]},
  aqua:   {prefixes:[], bases:["aqua"], suffixes:["-tic","-marine","-duct","-rium","-plane"]}
};

const Fresh = (()=>{ const used=new Map(); const key=(a,m)=>a+':'+m;
  function pick(a,m,pool,count){ const k=key(a,m); if(!used.has(k)) used.set(k,new Set());
    const u=used.get(k); const avail=pool.filter(x=>!u.has(x)); if(avail.length<count){ u.clear(); avail.splice(0,avail.length,...pool); }
    const res=[]; const c=[...avail]; while(res.length<Math.min(count,c.length)){ const i=Math.floor(Math.random()*c.length); res.push(...c.splice(i,1)); }
    res.forEach(x=>u.add(x)); return res; } return {pick};})();

const pages = ['page-main-menu','page-morpheme-list','page-activity-menu','page-word-sums','page-fill-in-blanks','page-word-matrix','page-morpheme-hunt','page-spelling-chaining'];
let currentCategory='', currentMorpheme='';
const pageBgMap = {'page-main-menu':'bg-activity-default','page-morpheme-list':'bg-activity-default','page-activity-menu':'bg-activity-default','page-word-sums':'bg-activity-sums','page-fill-in-blanks':'bg-activity-cloze','page-word-matrix':'bg-activity-matrix','page-morpheme-hunt':'bg-activity-hunt','page-spelling-chaining':'bg-activity-chaining'};
function applyActivityBackground(pageId){
  document.body.className = document.body.className.replace(/\bbg-activity-\w+\b/g,'').trim();
  document.body.classList.add(pageBgMap[pageId]||'bg-activity-default');
}
function showPage(id){ pages.forEach(pid=>{ const el=document.getElementById(pid); if(el) el.classList.toggle('hidden', pid!==id);}); applyActivityBackground(id); }

function showMorphemeList(category){
  currentCategory=category; const grid=document.getElementById('morpheme-grid');
  document.getElementById('morpheme-list-title').textContent=category[0].toUpperCase()+category.slice(1);
  grid.innerHTML=''; morphemes[category].forEach(m=>{ const b=document.createElement('button');
    b.className='card bg-white p-4 rounded-lg shadow-sm border text-center font-semibold text-slate-800 hover:border-violet-400 hover:text-violet-600';
    b.textContent=m; b.onclick=()=>showActivityMenu(m); grid.appendChild(b); }); showPage('page-morpheme-list');
}

function showActivityMenu(m){
  currentMorpheme=m; document.getElementById('selected-morpheme-title').textContent=`'${m}'`;
  document.getElementById('back-to-morpheme-list').onclick=()=>showMorphemeList(currentCategory);
  // Filter Word Matrix card visibility — only show for base morphemes available in MATRIX_SPEC
  const hasMatrix = !!MATRIX_SPEC[m];
  document.querySelector('[data-activity=\"page-word-matrix\"]').style.display = hasMatrix ? 'block':'none';
  showPage('page-activity-menu');
}

function showActivityPage(pageId){
  showPage(pageId);
  if(pageId==='page-word-sums') generateWordSums();
  if(pageId==='page-fill-in-blanks') generateClozeActivity();
  if(pageId==='page-word-matrix') generateWordMatrix();
  if(pageId==='page-morpheme-hunt') generateMorphemeHunt();
  if(pageId==='page-spelling-chaining') generateSpellingChaining();
}

// Word Sums
let currentWordSums=[];
function splitForSum(morph, word){
  if(morph.endsWith('-')){ const stem=word.replace(new RegExp('^'+morph.replace('-','')),''); return [morph.replace('-',''),'+',stem]; }
  if(morph.startsWith('-')){ const stem=word.replace(new RegExp(morph.replace('-','')+'$'),''); return [stem,'+',morph.replace('-','')]; }
  const prefixes=Object.keys(DICT).filter(k=>k.endsWith('-') && word.startsWith(k.replace('-',''))).map(k=>k.replace('-',''));
  const suffixes=Object.keys(DICT).filter(k=>k.startsWith('-') && word.endsWith(k.replace('-',''))).map(k=>k.replace('-',''));
  const pre=prefixes[0]||'', suf=suffixes[0]||''; const baseOnly=word.replace(new RegExp('^'+pre),'').replace(new RegExp(suf+'$'),'');
  return [pre && pre, pre && '+', baseOnly, suf && '+', suf].filter(Boolean);
}
function generateWordSums(){
  const container=document.getElementById('word-sums-container'); container.innerHTML=''; document.getElementById('word-sums-score').textContent='';
  const pool=[...new Set(DICT[currentMorpheme]||[])].filter(w=>w.length>=4);
  if(pool.length===0){ container.innerHTML='<p class=\"text-center text-slate-500\">No activities available.</p>'; return; }
  const picked=Fresh.pick('sums', currentMorpheme, pool, 8);
  currentWordSums=picked.map(w=>({sum: splitForSum(currentMorpheme,w).join(' '), result:w}));
  currentWordSums.forEach((item,idx)=>{ const row=document.createElement('div'); row.className='grid grid-cols-1 sm:grid-cols-2 gap-4 items-center';
    row.innerHTML=`<div class=\"bg-white p-4 rounded-lg text-center text-lg font-mono shadow-sm border\">${item.sum}</div>
    <input type=\"text\" data-index=\"${idx}\" class=\"text-lg p-4 w-full border-2 border-slate-300 rounded-lg\" placeholder=\"Type here...\">`; container.appendChild(row); });
}
function checkWordSums(){ let correct=0; document.querySelectorAll('#word-sums-container input').forEach(input=>{ const i=+input.dataset.index, user=input.value.trim().toLowerCase(), corr=currentWordSums[i].result;
  input.classList.remove('border-green-500','border-red-500'); if(user===corr){ input.classList.add('border-green-500'); correct++; } else { input.classList.add('border-red-500'); }});
  document.getElementById('word-sums-score').textContent=`You got ${correct} / ${currentWordSums.length} correct!`; }

// Fill-in-the-Blanks
let clozeAnswers=[];
function simpleSentence(word){ const low=word.toLowerCase(); if(low.endsWith('ing')) return `They are ___ right now.`; if(low.endsWith('ed')) return `We ___ yesterday.`; if(low.endsWith('s')) return `She often ___ after school.`; if(low.includes('un')) return `That is very ___ in this class.`; return `Please write the word ___ in your book.`; }
function generateClozeActivity(){
  const bank=[...new Set(DICT[currentMorpheme]||[])]; const wordBank=document.getElementById('cloze-word-bank'); const sentences=document.getElementById('cloze-sentences');
  document.getElementById('cloze-score').textContent=''; wordBank.innerHTML=''; sentences.innerHTML='';
  if(bank.length===0){ sentences.innerHTML='<p class=\"text-center text-slate-500\">No activities available.</p>'; return; }
  const chosen=Fresh.pick('cloze', currentMorpheme, bank, 8); clozeAnswers=chosen.slice();
  chosen.slice().sort(()=>Math.random()-0.5).forEach(w=>{ const el=document.createElement('div'); el.id=`drag-${w}`; el.textContent=w; el.className='draggable bg-sky-100 text-sky-800 font-medium py-2 px-4 rounded-lg border border-sky-200'; el.draggable=true; el.addEventListener('dragstart', ev=>ev.dataTransfer.setData('text/plain', el.id)); wordBank.appendChild(el); });
  chosen.forEach((w,idx)=>{ const p=document.createElement('p'); p.innerHTML=`${idx+1}. ${simpleSentence(w).replace('___', '<span class=\"drop-zone inline-block w-40 h-10 align-middle mx-2 rounded-lg\" data-index=\"'+idx+'\"></span>')}`; sentences.appendChild(p); });
  document.querySelectorAll('.drop-zone').forEach(zone=>{ zone.addEventListener('dragover', e=>{ e.preventDefault(); zone.classList.add('drag-over'); }); zone.addEventListener('dragleave', ()=>zone.classList.remove('drag-over'));
    zone.addEventListener('drop', e=>{ e.preventDefault(); zone.classList.remove('drag-over'); const id=e.dataTransfer.getData('text/plain'); const drag=document.getElementById(id); if(zone.firstChild) document.getElementById('cloze-word-bank').appendChild(zone.firstChild); zone.appendChild(drag); }); });
}
function checkClozeAnswers(){ let correct=0,total=clozeAnswers.length; document.querySelectorAll('.drop-zone').forEach(zone=>{ const i=+zone.dataset.index; const w=zone.firstChild?.textContent||'';
  zone.classList.remove('border-green-500','border-red-500','border-2'); zone.classList.add('border-2'); if(w===clozeAnswers[i]){ zone.classList.add('border-green-500'); correct++; } else zone.classList.add('border-red-500'); });
  document.getElementById('cloze-score').textContent=`You got ${correct} / ${total} correct!`; }

// Word Matrix
let matrixFoundWords=[], matrixValid=[];
function generateWordMatrix(){
  const spec = MATRIX_SPEC[currentMorpheme]; const grid=document.getElementById('matrix-grid');
  grid.innerHTML='<div><h3 class=\"font-bold mb-2 border-b-2 pb-1\">Prefixes</h3><div id=\"matrix-prefixes\" class=\"space-y-2\"></div></div>'+
                 '<div><h3 class=\"font-bold mb-2 border-b-2 pb-1\">Bases</h3><div id=\"matrix-bases\" class=\"space-y-2\"></div></div>'+
                 '<div><h3 class=\"font-bold mb-2 border-b-2 pb-1\">Suffixes</h3><div id=\"matrix-suffixes\" class=\"space-y-2\"></div></div>';
  matrixFoundWords=[]; matrixValid=[]; updateFoundList();
  if(!spec){ grid.innerHTML='<p class=\"col-span-3 text-center text-slate-500\">No matrix for this morpheme.</p>'; return; }
  const dict=new Set(DICT[currentMorpheme] || DICT[spec.bases[0]] || []);
  const {prefixes,bases,suffixes}=spec; const combos=new Set();
  bases.forEach(b=>{ if(dict.has(b)) combos.add(b); });
  bases.forEach(b=>suffixes.forEach(s=>{ const w=b+s.replace(/^-/, ''); if(dict.has(w)) combos.add(w);}));
  prefixes.forEach(p=>bases.forEach(b=>{ const w=p.replace(/-$/,'')+b; if(dict.has(w)) combos.add(w);}));
  prefixes.forEach(p=>bases.forEach(b=>suffixes.forEach(s=>{ const w=p.replace(/-$/,'')+b+s.replace(/^-/, ''); if(dict.has(w)) combos.add(w);})));
  matrixValid=[...combos].sort();
  const preC=document.getElementById('matrix-prefixes'), basC=document.getElementById('matrix-bases'), sufC=document.getElementById('matrix-suffixes');
  function mkBtn(txt){ const btn=document.createElement('button'); btn.textContent=txt; btn.className='w-full bg-slate-100 hover:bg-slate-200 p-2 rounded-md font-mono'; btn.onclick=()=>document.getElementById('matrix-current-word').textContent += txt.replace(/[-]/g,''); return btn; }
  prefixes.forEach(p=>preC.appendChild(mkBtn(p))); bases.forEach(b=>basC.appendChild(mkBtn(b))); suffixes.forEach(s=>sufC.appendChild(mkBtn(s)));
}
function clearMatrixWord(){ document.getElementById('matrix-current-word').textContent=''; }
function setFeedback(msg,err=false){ const el=document.getElementById('matrix-feedback'); el.textContent=msg; el.className='text-center mt-3 h-6 font-medium '+(err?'text-red-500':'text-green-500'); setTimeout(()=>{ el.textContent=''; },1600); }
function submitMatrixWord(){ const word=document.getElementById('matrix-current-word').textContent.trim(); if(!word) return;
  if(matrixValid.includes(word)){ if(matrixFoundWords.includes(word)) setFeedback('Already found!',true); else { matrixFoundWords.push(word); updateFoundList(); setFeedback('Correct!'); } }
  else setFeedback('Not in word list.', true); clearMatrixWord(); }
function updateFoundList(){ const list=document.getElementById('matrix-found-list'); list.innerHTML=''; matrixFoundWords.sort().forEach(w=>{ const li=document.createElement('li'); li.className='bg-green-100 text-green-800 p-2 rounded text-sm font-mono'; li.textContent=w; list.appendChild(li); }); document.getElementById('matrix-found-count').textContent=matrixFoundWords.length; }

// Morpheme Hunt
let huntCorrect=[];
function generateMorphemeHunt(){
  const list=[...new Set(DICT[currentMorpheme]||[])]; const grid=document.getElementById('hunt-grid');
  grid.innerHTML=''; document.getElementById('hunt-score').textContent=''; if(list.length===0){ grid.innerHTML='<p class=\"col-span-full text-center text-slate-500\">No hunt available.</p>'; return; }
  document.getElementById('hunt-instructions').textContent=`Click all the words that contain '${currentMorpheme}'.`; const correct=Fresh.pick('hunt',currentMorpheme,list,8); huntCorrect=correct;
  function distort(w){ if(currentMorpheme.endsWith('-')){ const bare=w.replace(new RegExp('^'+currentMorpheme.replace('-','')), ''); return bare.length>3?bare:w+'e'; }
    if(currentMorpheme.startsWith('-')){ const bare=w.replace(new RegExp(currentMorpheme.replace('-','')+'$'), ''); return bare.length>3?bare:'very'+bare; }
    return w.replace(currentMorpheme, currentMorpheme[0]+'x'+currentMorpheme.slice(1)); }
  const distractors=correct.map(distort); const all=[...correct,...distractors].sort(()=>Math.random()-0.5);
  all.forEach(word=>{ const el=document.createElement('button'); el.textContent=word; el.className='hunt-word border-2 border-slate-300 bg-white p-4 rounded-lg text-center font-medium transition-colors'; el.onclick=()=>el.classList.toggle('selected'); grid.appendChild(el);});
}
function checkMorphemeHunt(){ let good=0,bad=0; const total=huntCorrect.length; const set=new Set(huntCorrect);
  document.querySelectorAll('.hunt-word').forEach(btn=>{ const w=btn.textContent, sel=btn.classList.contains('selected'), isCorrect=set.has(w);
    btn.classList.remove('border-green-500','border-red-500'); if(sel && isCorrect){ btn.classList.add('border-green-500'); good++; } else if(sel && !isCorrect){ btn.classList.add('border-red-500'); bad++; } else if(!sel && isCorrect){ btn.classList.add('border-red-500'); } });
  document.getElementById('hunt-score').textContent=`You found ${good} of ${total} correct words, with ${bad} incorrect selections.`; }

// Spelling Chaining — ensure multi-step chains even for prefix/suffix sets
let chain=[], stepIdx=0;
function regularInflect(word){ // return [ed, ing, s] where applicable
  const base=word;
  const ed = base.endsWith('e') ? base+'d' : base+'ed';
  const ing = base.endsWith('e') ? base.slice(0,-1)+'ing' : base+'ing';
  const s = base.endsWith('s') ? base+'es' : base+'s';
  return [ed, ing, s];
}
function generateSpellingChaining(){
  const words=[...new Set(DICT[currentMorpheme]||[])]; const container=document.getElementById('chaining-container'); container.innerHTML='';
  if(words.length===0){ container.innerHTML='<p class=\"text-center text-slate-500\">No chain available.</p>'; return; }
  const seed=(Fresh.pick('chain', currentMorpheme, words.filter(w=>/^[a-z]+$/i.test(w) && w.length>=4), 1)[0]) || words[0];
  chain=[{label:'start', result:seed}];
  // Prefer affix-based steps when possible; otherwise fall back to regular inflections
  const preKey = Object.keys(DICT).find(k=>k.endsWith('-') && words.includes(k.replace('-','')+seed));
  if(preKey) chain.push({instruction:`Add '${preKey.replace('-','')}-'`, result: preKey.replace('-','')+seed});
  const last1=chain[chain.length-1].result;
  const sufKey = Object.keys(DICT).find(k=>k.startsWith('-') && words.includes(last1 + k.replace('-','')));
  if(sufKey) chain.push({instruction:`Add '-${sufKey.replace('-','')}'`, result: last1 + sufKey.replace('-','')});
  // If still short, pad with regular inflections
  while(chain.length<4){
    const cur=chain[chain.length-1].result; const [ed,ing,s] = regularInflect(cur);
    const nexts=[ed,ing,s].filter(n=>n!==cur);
    const next=nexts.find(n=>true);
    if(!next) break;
    const instr = next===ed?\"Add '-ed'\":(next===ing?\"Add '-ing'\":\"Add '-s'\");
    chain.push({instruction:instr, result:next});
  }
  stepIdx=0; renderChainStep();
}
function renderChainStep(){
  const container=document.getElementById('chaining-container');
  if(stepIdx===0){
    const s=document.createElement('div'); s.className='p-4';
    s.innerHTML = `<div class=\"flex items-center gap-3\"><span class=\"text-2xl font-bold font-mono bg-slate-100 px-3 py-1 rounded\">${chain[0].result}</span>
      <span class=\"text-slate-500 text-2xl\">&rarr;</span><span class=\"text-slate-600\">Follow the prompts below.</span></div>`;
    container.appendChild(s); stepIdx=1;
  }
  if(stepIdx>=chain.length){ const done=document.createElement('div'); done.className='text-center p-4 bg-green-100 text-green-800 rounded-lg font-bold'; done.textContent='Chain Complete!'; container.appendChild(done); return; }
  const step=chain[stepIdx]; const prev=chain[stepIdx-1].result; const block=document.createElement('div'); block.className='p-4';
  block.innerHTML = `<div class=\"flex flex-wrap items-center gap-4\">
      <span class=\"text-2xl font-bold font-mono bg-slate-100 px-3 py-1 rounded\">${prev}</span>
      <span class=\"text-slate-500 text-2xl\">&rarr;</span>
      <span class=\"text-slate-600 font-medium flex-1\">${step.instruction || 'Type the next form'}</span>
    </div>
    <div class=\"mt-3 flex gap-3\">
      <input id=\"step-${stepIdx}-input\" class=\"text-lg p-3 w-full border-2 border-slate-300 rounded-lg\" placeholder=\"Type new word...\">
      <button onclick=\"checkChainStep()\" class=\"bg-teal-500 hover:bg-teal-600 text-white font-bold px-5 rounded-lg\">Go</button>
    </div>
    <p id=\"step-${stepIdx}-feedback\" class=\"h-5 mt-1 text-sm font-medium\"></p>`;
  container.appendChild(block); document.getElementById(`step-${stepIdx}-input`).focus();
}
function checkChainStep(){
  const input=document.getElementById(`step-${stepIdx}-input`); const fb=document.getElementById(`step-${stepIdx}-feedback`);
  const want=chain[stepIdx].result.toLowerCase(); const got=(input.value||'').trim().toLowerCase();
  input.classList.remove('border-red-500','border-green-500');
  if(got===want){ input.disabled=true; input.classList.add('border-green-500','bg-slate-50'); fb.textContent='Correct!'; fb.className='h-5 mt-1 text-sm font-medium text-green-600'; stepIdx++; renderChainStep(); }
  else { fb.textContent='Not quite, try again.'; fb.className='h-5 mt-1 text-sm font-medium text-red-600'; input.classList.add('border-red-500'); }
}

document.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('page-word-sums').innerHTML = document.getElementById('word-sums-template').innerHTML;
  document.getElementById('page-fill-in-blanks').innerHTML = document.getElementById('fill-in-blanks-template').innerHTML;
  document.getElementById('page-word-matrix').innerHTML = document.getElementById('word-matrix-template').innerHTML;
  document.getElementById('page-morpheme-hunt').innerHTML = document.getElementById('morpheme-hunt-template').innerHTML;
  document.getElementById('page-spelling-chaining').innerHTML = document.getElementById('spelling-chaining-template').innerHTML;
  showPage('page-main-menu');
});
</script>
</body>
</html>
